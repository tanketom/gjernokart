<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hendingskart for Bærekraftige Liv Landås</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
     integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
     crossorigin=""/>
    <!-- Marker Cluster CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
     integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
     crossorigin=""></script>
    <!-- Marker Cluster JS -->
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>
    <!-- Geohash library is now included directly in the script below -->

    <style>
        /* Set a default height for the map container */
        #map {
            height: 70vh;
            width: 100%;
        }
        /* Simple spinner animation */
        .loader {
            border: 5px solid #f3f3f3;
            border-top: 5px solid #3498db;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .marker-cluster-small {
            background-color: rgba(18, 115, 222, 0.6);
        }
        .marker-cluster-small div {
            background-color: rgba(18, 103, 222, 0.6);
        }
    </style>
</head>
<body class="bg-gray-100 font-sans antialiased text-gray-800">

    <div class="container mx-auto p-4 md:p-8">
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Hendingskart for Bærekraftige Liv Landås</h1>
        </div>

        <!-- Form for user input -->
        <div class="bg-white rounded-xl shadow-lg p-6 mb-6">
            <form id="mobilizon-form" class="grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
                
                <!-- Accordion Container (2/3 width) -->
                <div class="md:col-span-2">
                    <!-- Accordion Header -->
                    <div id="accordion-header" class="flex justify-between items-center cursor-pointer">
                        <h2 class="text-xl font-bold text-gray-900">Endre søkefilter</h2>
                        <svg id="accordion-arrow" class="w-6 h-6 transition-transform transform" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" >
                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
                        </svg>
                    </div>
        
                    <!-- Accordion Body (contains the inputs) -->
                    <div id="accordion-body" class="hidden mt-4">
                        <div class="mb-4 border-b pb-4">
                            <label class="flex items-center space-x-2 cursor-pointer">
                                <input type="checkbox" id="search-bergen" class="h-5 w-5 rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                                <span class="text-gray-700 font-medium">Alt i Bergen (også utanfor Bærekraftige Liv Landås)</span>
                            </label>
                        </div>
                        <p class="text-gray-600 mb-4">
                            Eller, legg til Mobilizon-instans (td., <code class="bg-gray-200 p-1 rounded">https://gjer.no</code>)
                            og eventuelt gruppenamn (td., <code class="bg-gray-200 p-1 rounded">bll</code>) for å vise hendingar.
                        </p>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                            <label for="instance-url" class="sr-only">Mobilizon-instans</label>
                            <input type="text" id="instance-url" placeholder="Mobilizon-instans" class="w-full px-4 py-2 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" value="https://gjer.no">
                            
                            <label for="group-name" class="sr-only">Gruppenamn (valgfritt)</label>
                            <input type="text" id="group-name" placeholder="Gruppenamn (valfritt)" class="w-full px-4 py-2 text-gray-700 bg-gray-50 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 transition duration-200" value="bll">
                        </div>
                    </div>
                </div>

                <!-- Button (1/3 width) -->
                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-md focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500 self-center">
                    Last hendingar
                </button>
            </form>
        </div>

        <!-- Map and Loading/Error states -->
        <div class="bg-white rounded-xl shadow-lg p-2 relative">
             <div id="map" class="rounded-lg z-0"></div>
             <!-- Overlay for loading spinner and messages -->
             <div id="map-overlay" class="absolute inset-0 bg-white bg-opacity-75 flex-col items-center justify-center rounded-lg z-10 hidden">
                <div id="loader" class="loader mb-4"></div>
                <p id="message-area" class="text-gray-700 font-semibold text-lg"></p>
            </div>
        </div>

        <!-- Event List Section -->
        <div class="bg-white rounded-xl shadow-lg p-6 mt-6">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Hendingar</h2>
            <div id="event-list" class="space-y-4 max-h-96 overflow-y-auto">
                <!-- Event items will be inserted here by JavaScript -->
                <p class="text-gray-500">Lastar hendingar...</p>
            </div>
        </div>

    </div>

    <script>
        // DOM element references
        const form = document.getElementById('mobilizon-form');
        const urlInput = document.getElementById('instance-url');
        const groupInput = document.getElementById('group-name');
        const bergenCheckbox = document.getElementById('search-bergen');
        const mapOverlay = document.getElementById('map-overlay');
        const loader = document.getElementById('loader');
        const messageArea = document.getElementById('message-area');
        const eventListContainer = document.getElementById('event-list');
        const accordionHeader = document.getElementById('accordion-header');
        const accordionBody = document.getElementById('accordion-body');
        const accordionArrow = document.getElementById('accordion-arrow');

        // --- Start of Self-contained Geohash implementation ---
        const BASE32 = '0123456789bcdefghjkmnpqrstuvwxyz';
        const encodeGeohash = (latitude, longitude, precision) => {
            let latRange = { min: -90, max: 90 };
            let lonRange = { min: -180, max: 180 };
            let geohash = '';
            let isEven = true;
            let bit = 0;
            let ch = 0;

            while (geohash.length < precision) {
                if (isEven) {
                    const mid = (lonRange.min + lonRange.max) / 2;
                    if (longitude > mid) {
                        ch |= (1 << (4 - bit));
                        lonRange.min = mid;
                    } else {
                        lonRange.max = mid;
                    }
                } else {
                    const mid = (latRange.min + latRange.max) / 2;
                    if (latitude > mid) {
                        ch |= (1 << (4 - bit));
                        latRange.min = mid;
                    } else {
                        latRange.max = mid;
                    }
                }

                isEven = !isEven;
                bit++;

                if (bit === 5) {
                    geohash += BASE32[ch];
                    bit = 0;
                    ch = 0;
                }
            }
            return geohash;
        };
        // --- End of Self-contained Geohash implementation ---


        // Initialize map
        const map = L.map('map').setView([60.39, 5.32], 13); // Centered on Bergen
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
        }).addTo(map);

        // Layer group to manage clustered markers
        let markers = L.markerClusterGroup();
        map.addLayer(markers);

        // GraphQL query to fetch all public events (can include location filters)
        const allEventsQuery = `
            query SearchEvents($beginsOn: DateTime, $location: String, $radius: Float) {
                searchEvents(beginsOn: $beginsOn, location: $location, radius: $radius) {
                    elements {
                        title
                        url
                        beginsOn
                        physicalAddress {
                            description
                            locality
                            region
                            country
                            geom
                        }
                    }
                }
            }
        `;

        // GraphQL query to fetch events for a specific group
        const groupEventsQuery = `
            query GroupEvents($groupName: String!) {
                group(preferredUsername: $groupName) {
                    organizedEvents {
                        elements {
                            title
                            url
                            beginsOn
                            endsOn
                            physicalAddress {
                                description
                                locality
                                region
                                country
                                geom
                            }
                        }
                    }
                }
            }
        `;

        // Function to show a message on the map overlay
        const showMessage = (message, showLoader = false) => {
            mapOverlay.style.display = 'flex';
            loader.style.display = showLoader ? 'block' : 'none';
            messageArea.textContent = message;
        };
        
        // Function to hide the overlay
        const hideOverlay = () => {
            mapOverlay.style.display = 'none';
        };

        // Function to fetch and display events
        const fetchAndDisplayEvents = async (instanceUrl, groupName, isBergenSearch) => {
            markers.clearLayers(); // Clear previous markers from the cluster group
            eventListContainer.innerHTML = ''; // Clear previous list
            showMessage('Lastar hendingar...', true);

            try {
                // Determine which query and variables to use
                const isGroupSearch = !isBergenSearch && groupName && groupName.trim() !== '';
                let query;
                const variables = {};

                if (isGroupSearch) {
                    query = groupEventsQuery;
                    variables.groupName = groupName.trim();
                } else {
                    // Both Bergen search and instance-wide search use searchEvents
                    query = allEventsQuery;
                    variables.beginsOn = new Date().toISOString();
                    if (isBergenSearch) {
                        const bergenLat = 60.39;
                        const bergenLon = 5.32;
                        // Use the self-contained geohash function
                        variables.location = encodeGeohash(bergenLat, bergenLon, 6); // Precision 6 is ~0.6km
                        variables.radius = 25; // 25 km
                    }
                }
                
                // Ensure URL has a protocol
                let url = instanceUrl.trim();
                if (!url.startsWith('http')) {
                   url = 'https://' + url;
                }
                const apiUrl = new URL('/api', url).href;
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' },
                    body: JSON.stringify({ 
                        query: query,
                        variables: variables
                    })
                });

                if (!response.ok) {
                    throw new Error(`Nettverksrespons var ikkje ok: ${response.statusText}`);
                }

                const result = await response.json();

                if (result.errors) {
                    console.error('GraphQL Errors:', result.errors);
                    throw new Error(result.errors.map(e => e.message).join('\n'));
                }
                
                let rawEvents = [];
                if (isGroupSearch) {
                    if (result.data.group && result.data.group.organizedEvents) {
                        rawEvents = result.data.group.organizedEvents.elements;
                    } else {
                         showMessage(`Fann ikkje gruppa "${groupName}" eller ho har ingen hendingar.`);
                         eventListContainer.innerHTML = `<p class="text-gray-500">Fann ikkje gruppa "${groupName}" eller ho har ingen hendingar.</p>`;
                         return;
                    }
                } else {
                    rawEvents = result.data.searchEvents.elements;
                }

                // For group searches, we filter upcoming events on the client side
                const now = new Date();
                const events = isGroupSearch
                    ? rawEvents.filter(event => event.endsOn && new Date(event.endsOn) >= now)
                    : rawEvents;


                if (!events || events.length === 0) {
                    showMessage('Fann ingen komande offentlege hendingar for dette søket.');
                    eventListContainer.innerHTML = '<p class="text-gray-500">Ingen hendingar å vise.</p>';
                    return;
                }

                const eventsToGeocode = [];
                const eventsWithCoords = [];

                events.forEach(event => {
                    if (event.physicalAddress?.geom && typeof event.physicalAddress.geom === 'string' && event.physicalAddress.geom.includes(';')) {
                        const [longitude, latitude] = event.physicalAddress.geom.split(';').map(Number);
                        if (!isNaN(latitude) && !isNaN(longitude)) {
                            eventsWithCoords.push({ event, latitude, longitude });
                        }
                    } else if (event.physicalAddress) {
                        eventsToGeocode.push(event);
                    }
                });
                
                // Geocode events that need it
                const geocodePromises = eventsToGeocode.map(async (event) => {
                    const { description, locality, region, country } = event.physicalAddress;
                    // Construct a query string, filtering out null/undefined parts
                    const addressQuery = [description, locality, region, country].filter(Boolean).join(', ');
                    
                    if (!addressQuery) return null;

                    const nominatimUrl = `https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(addressQuery)}`;
                    
                    try {
                        const geoResponse = await fetch(nominatimUrl);
                        const geoData = await geoResponse.json();
                        if (geoData && geoData.length > 0) {
                            return {
                                event,
                                latitude: parseFloat(geoData[0].lat),
                                longitude: parseFloat(geoData[0].lon)
                            };
                        }
                    } catch (e) {
                        console.error(`Geokoding feila for "${addressQuery}":`, e);
                    }
                    return null;
                });
                
                const geocodedEvents = (await Promise.all(geocodePromises)).filter(Boolean);
                const allMappableEvents = [...eventsWithCoords, ...geocodedEvents];

                if (allMappableEvents.length === 0) {
                     showMessage('Fann ingen offentlege hendingar med ein gyldig fysisk plassering.');
                     eventListContainer.innerHTML = '<p class="text-gray-500">Ingen hendingar med gyldig plassering funne.</p>';
                     return;
                }
                
                const dateTimeFormatter = new Intl.DateTimeFormat('nb-NO', {
                    weekday: 'long',
                    day: 'numeric',
                    month: 'long',
                    hour: 'numeric',
                    minute: 'numeric',
                    timeZone: 'Europe/Oslo'
                });

                allMappableEvents.forEach(({ event, latitude, longitude }) => {
                    const { description, locality } = event.physicalAddress || {};
                    const marker = L.marker([latitude, longitude]);
                    
                    const locationText = locality || description || 'Stad ikkje spesifisert';
                    let formattedDate = '';
                    if (event.beginsOn) {
                        formattedDate = dateTimeFormatter.format(new Date(event.beginsOn));
                    }

                    const popupContent = `
                        <h3 class="font-bold text-lg mb-1">
                            <a href="${event.url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800">${event.title}</a>
                        </h3>
                        <p class="text-gray-700">${locationText}</p>
                        ${formattedDate ? `<p class="text-gray-600 font-medium">${formattedDate}</p>` : ''}
                    `;
                    
                    marker.bindPopup(popupContent);
                    markers.addLayer(marker);

                    // Create and append the list item
                    const listItem = document.createElement('div');
                    listItem.className = 'p-4 border-b last:border-b-0 hover:bg-gray-50 transition cursor-pointer';
                    listItem.innerHTML = `
                        <h3 class="font-bold text-lg">
                            <a href="${event.url}" target="_blank" rel="noopener noreferrer" class="text-blue-600 hover:text-blue-800">${event.title}</a>
                        </h3>
                        <p class="text-gray-700">${locationText} - <span class="font-medium">${formattedDate}</span></p>
                    `;
                    listItem.addEventListener('click', () => {
                        map.setView([latitude, longitude], 15);
                        // To open the popup on a clustered marker, we need to zoom in first.
                        markers.zoomToShowLayer(marker, () => {
                            marker.openPopup();
                        });
                    });
                    eventListContainer.appendChild(listItem);
                });

                // Adjust map view to fit all markers
                if (allMappableEvents.length > 0) {
                    map.fitBounds(markers.getBounds(), { padding: [50, 50] });
                }
                
                hideOverlay();

            } catch (error) {
                console.error('Failed to fetch events:', error);
                showMessage(`Feil: Kunne ikkje laste hendingar. Sjekk URL-en og konsollen for detaljar.`);
            }
        };

        // Event listener for the form submission
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            const instanceUrl = document.getElementById('instance-url').value;
            const groupName = document.getElementById('group-name').value;
            const isBergenSearch = bergenCheckbox.checked;

            if (instanceUrl) {
                fetchAndDisplayEvents(instanceUrl, groupName, isBergenSearch);
            } else {
                showMessage("Ver venleg og skriv inn ein Mobilizon-instans URL.");
            }
        });

        // Accordion functionality
        accordionHeader.addEventListener('click', () => {
            accordionBody.classList.toggle('hidden');
            accordionArrow.classList.toggle('rotate-180');
        });

        // Disable group input when Bergen search is checked
        bergenCheckbox.addEventListener('change', () => {
            if (bergenCheckbox.checked) {
                groupInput.disabled = true;
                groupInput.classList.add('bg-gray-200');
            } else {
                groupInput.disabled = false;
                groupInput.classList.remove('bg-gray-200');
            }
        });

        // Initial load with the default values
        window.addEventListener('load', () => {
            const instanceUrl = document.getElementById('instance-url').value;
            const groupName = document.getElementById('group-name').value;
            const isBergenSearch = bergenCheckbox.checked;
            fetchAndDisplayEvents(instanceUrl, groupName, isBergenSearch);
        });
    </script>
</body>
</html>
